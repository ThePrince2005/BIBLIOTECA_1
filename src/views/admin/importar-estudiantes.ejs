<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('../partials/head', { title: 'Importar Estudiantes - Biblioteca Escolar' }) %>
    <style>
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #4299e1;
            background-color: #f7fafc;
        }
        .upload-area.dragover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .btn-importar {
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-importar:hover {
            background-color: #3182ce;
        }
        .results {
            margin-top: 2rem;
        }
        .error-row {
            background-color: #fff5f5;
        }
    </style>
</head>
<body class="bg-gray-100">
    <%- include('../partials/header') %>

    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Importar Estudiantes</h1>
            
            <% if (success && success.length > 0) { %>
                <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6" role="alert">
                    <p><%= success %></p>
                </div>
            <% } %>
            
            <% if (error && error.length > 0) { %>
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                    <p><%= error %></p>
                </div>
            <% } %>

            <% if (import_results) { %>
                <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500">
                    <h3 class="font-bold text-lg mb-2">Resultados de la importación:</h3>
                    <p>Total de registros procesados: <span class="font-semibold"><%= import_results.total %></span></p>
                    <p>Registros exitosos: <span class="font-semibold text-green-600"><%= import_results.success %></span></p>
                    <p>Errores: <span class="font-semibold text-red-600"><%= import_results.errors.length %></span></p>
                    
                    <% if (import_results.errors.length > 0) { %>
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2">Detalles de errores:</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="py-2 px-4 border text-left">Fila</th>
                                            <th class="py-2 px-4 border text-left">DNI</th>
                                            <th class="py-2 px-4 border text-left">Error</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% import_results.errors.forEach(err => { %>
                                            <tr class="error-row">
                                                <td class="py-2 px-4 border"><%= err.row %></td>
                                                <td class="py-2 px-4 border"><%= err.dni %></td>
                                                <td class="py-2 px-4 border text-red-600"><%= err.error %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    <% } %>
                </div>
            <% } %>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Instrucciones:</h2>
                <ol class="list-decimal pl-5 space-y-2">
                    <li>Descarga la plantilla de ejemplo <a href="/plantillas/plantilla-estudiantes.xlsx" class="text-blue-600 hover:underline">aquí</a>.</li>
                    <li>Llena la plantilla con los datos de los estudiantes.</li>
                    <li>Asegúrate de que el archivo tenga las siguientes columnas: <code class="bg-gray-100 px-2 py-1 rounded">DNI</code>, <code class="bg-gray-100 px-2 py-1 rounded">APELLIDOS</code>, <code class="bg-gray-100 px-2 py-1 rounded">NOMBRES</code>, <code class="bg-gray-100 px-2 py-1 rounded">GRADO</code>, <code class="bg-gray-100 px-2 py-1 rounded">SECCION</code>.</li>
                    <li>Sube el archivo completado usando el formulario a continuación.</li>
                </ol>
            </div>

            <form action="/admin/estudiantes/importar" method="POST" enctype="multipart/form-data" id="importForm">
                <div class="upload-area" id="dropArea">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">Arrastra y suelta tu archivo Excel aquí o haz clic para seleccionar</p>
                    <input type="file" name="archivo" id="fileInput" class="hidden" accept=".xlsx, .xls" required>
                    <button type="button" id="selectFileBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        Seleccionar archivo
                    </button>
                    <p id="fileName" class="mt-2 text-sm text-gray-500">Ningún archivo seleccionado</p>
                </div>

                <div class="mt-6 flex justify-end space-x-4">
                    <a href="/admin/usuarios" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cancelar
                    </a>
                    <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Importar Estudiantes
                    </button>
                </div>
            </form>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script>
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const fileName = document.getElementById('fileName');
        const form = document.getElementById('importForm');

        // Manejar clic en el botón de selección
        selectFileBtn.addEventListener('click', () => fileInput.click());

        // Actualizar nombre del archivo seleccionado
        fileInput.addEventListener('change', (e) => {
            if (fileInput.files.length > 0) {
                fileName.textContent = fileInput.files[0].name;
            } else {
                fileName.textContent = 'Ningún archivo seleccionado';
            }
        });

        // Manejar arrastrar y soltar
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('dragover');
        }

        function unhighlight() {
            dropArea.classList.remove('dragover');
        }

        // Manejar archivos soltados
        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length) {
                fileInput.files = files;
                fileName.textContent = files[0].name;
            }
        }

        // Validar antes de enviar
        form.addEventListener('submit', (e) => {
            if (fileInput.files.length === 0) {
                e.preventDefault();
                alert('Por favor, selecciona un archivo para importar.');
                return false;
            }
            
            const file = fileInput.files[0];
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt !== 'xlsx' && fileExt !== 'xls') {
                e.preventDefault();
                alert('Por favor, selecciona un archivo Excel (.xlsx o .xls)');
                return false;
            }
            
            // Mostrar indicador de carga
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Importando...';
            
            return true;
        });
    </script>
</body>
</html>
