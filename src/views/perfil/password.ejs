<!DOCTYPE html>
<html lang="es">

<head>
    <%- include('../partials/head', { title: 'Cambiar Contraseña' }) %>
        <link rel="stylesheet" href="/css/perfil.css">
</head>

<body class="perfil-body">
    <%- include('../partials/navbar') %>

        <main class="perfil-wrapper">
            <!-- Header -->
            <header class="perfil-hero" data-aos="fade-down">
                <div class="perfil-hero__left">
                    <div class="perfil-hero__badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>Seguridad de acceso</span>
                    </div>
                    <div class="perfil-hero__title">
                        <h1>Cambiar contraseña</h1>
                        <p>Actualiza tus credenciales y mantén tu cuenta protegida con una clave fuerte.</p>
                    </div>
                </div>
            </header>

            <!-- Formulario de Cambio de Contraseña -->
            <section class="perfil-grid perfil-grid--two" data-aos="fade-up" data-aos-delay="100">
                <!-- Información de Seguridad -->
                <article class="card card--elevated">
                    <div class="card__header">
                        <div>
                            <p class="card__eyebrow">
                                <i class="fas fa-lock"></i>
                                <span>Paso recomendado</span>
                            </p>
                            <h2 class="card__title">Protege tu identidad digital</h2>
                        </div>
                    </div>
                    <div class="card__body">
                        <p class="card__description">
                            Usa una contraseña única que combine letras, números y símbolos. Así evitamos accesos no
                            autorizados.
                        </p>
                        <div class="security-tips">
                            <div class="security-tip">
                                <i class="fas fa-check-circle"></i>
                                <span>No reutilices contraseñas de otros sistemas</span>
                            </div>
                            <div class="security-tip">
                                <i class="fas fa-check-circle"></i>
                                <span>Cambia tu clave periódicamente</span>
                            </div>
                            <div class="security-tip">
                                <i class="fas fa-check-circle"></i>
                                <span>Activa notificaciones para detectar actividades inusuales</span>
                            </div>
                        </div>
                    </div>
                </article>

                <!-- Formulario -->
                <article class="card card--elevated">
                    <div class="card__header">
                        <div>
                            <p class="card__eyebrow">
                                <i class="fas fa-key"></i>
                                <span>Nueva credencial</span>
                            </p>
                            <h2 class="card__title">Actualizar contraseña</h2>
                        </div>
                    </div>
                    <div class="card__body">
                        <form id="formPassword" class="perfil-form">
                            <div class="form-group">
                                <label class="form-label">Contraseña actual</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="currentPassword" name="currentPassword"
                                        class="form-input" required>
                                    <button type="button" class="password-toggle" data-target="currentPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nueva contraseña</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="newPassword" name="newPassword" class="form-input"
                                        required>
                                    <button type="button" class="password-toggle" data-target="newPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>

                            <div id="password-requirements" class="password-requirements" style="display: none;">
                                <p class="requirements-title">Tu nueva contraseña debe incluir:</p>
                                <div class="requirements-list">
                                    <div class="requirement" data-regex=".{8,}">
                                        <i class="fas fa-times-circle"></i>
                                        <span>Al menos 8 caracteres</span>
                                    </div>
                                    <div class="requirement" data-regex="[A-Z]">
                                        <i class="fas fa-times-circle"></i>
                                        <span>Una letra mayúscula</span>
                                    </div>
                                    <div class="requirement" data-regex="[a-z]">
                                        <i class="fas fa-times-circle"></i>
                                        <span>Una letra minúscula</span>
                                    </div>
                                    <div class="requirement" data-regex="[0-9]">
                                        <i class="fas fa-times-circle"></i>
                                        <span>Un número</span>
                                    </div>
                                    <div class="requirement" data-regex="[@$!%*?&]">
                                        <i class="fas fa-times-circle"></i>
                                        <span>Un símbolo (@, $, !, %, etc.)</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Confirmar nueva contraseña</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="confirmPassword" name="confirmPassword"
                                        class="form-input" required>
                                    <button type="button" class="password-toggle" data-target="confirmPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="form-actions">
                                <a href="/perfil" class="btn btn--secondary">
                                    <i class="fas fa-times"></i>
                                    Cancelar
                                </a>
                                <button type="submit" class="btn btn--primary">
                                    <i class="fas fa-shield-alt"></i>
                                    Actualizar contraseña
                                </button>
                            </div>
                        </form>
                    </div>
                </article>
            </section>
        </main>

        <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
        <script>
            AOS.init({ duration: 800, once: true });

            document.addEventListener('DOMContentLoaded', () => {
                // Toggle password visibility
                const toggleButtons = document.querySelectorAll('.password-toggle');
                toggleButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetInput = document.getElementById(btn.dataset.target);
                        const icon = btn.querySelector('i');
                        const isPassword = targetInput.type === 'password';
                        targetInput.type = isPassword ? 'text' : 'password';
                        icon.classList.toggle('fa-eye', !isPassword);
                        icon.classList.toggle('fa-eye-slash', isPassword);
                    });
                });

                // Password requirements validation
                const newPasswordInput = document.getElementById('newPassword');
                const requirementsBox = document.getElementById('password-requirements');
                const requirementItems = requirementsBox.querySelectorAll('.requirement');

                const updateRequirements = () => {
                    const password = newPasswordInput.value;
                    if (password) {
                        requirementsBox.style.display = 'block';
                    } else {
                        requirementsBox.style.display = 'none';
                    }

                    requirementItems.forEach(req => {
                        const regex = new RegExp(req.dataset.regex);
                        const valid = regex.test(password);
                        req.classList.toggle('valid', valid);
                        const icon = req.querySelector('i');
                        icon.classList.toggle('fa-check-circle', valid);
                        icon.classList.toggle('fa-times-circle', !valid);
                    });
                };

                newPasswordInput.addEventListener('input', updateRequirements);
                newPasswordInput.addEventListener('blur', () => {
                    if (!newPasswordInput.value) {
                        requirementsBox.style.display = 'none';
                    }
                });

                // Form submission
                document.getElementById('formPassword').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    if (newPassword !== confirmPassword) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Las nuevas contraseñas no coinciden.',
                            confirmButtonColor: '#00B4D8'
                        });
                        return;
                    }

                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());

                    try {
                        const response = await fetch('/perfil/password', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();

                        if (response.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Contraseña actualizada!',
                                text: result.message,
                                confirmButtonColor: '#00B4D8'
                            }).then(() => {
                                window.location.href = '/perfil';
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: result.message || 'No se pudo cambiar la contraseña.',
                                confirmButtonColor: '#00B4D8'
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de conexión',
                            text: 'No se pudo conectar con el servidor.',
                            confirmButtonColor: '#00B4D8'
                        });
                    }
                });
            });
        </script>
</body>

</html>